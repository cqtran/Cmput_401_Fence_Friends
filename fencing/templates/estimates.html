{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
  <h1>Fencing Estimation Values</h1>
</div>
<hr class="mt-2">
<div class="container-fluid">
  <form id="upload-form" enctype=multipart/form-data >
		<input class="form-control" type="hidden" name="company_name" id="company_name" />
		<div class="row">
			<div class="col-sm-12 less-padding">
				<label for="file-upload" class="btn btn-primary btn-block">
				    Update Estimation Values
				</label>
		  		<input class="btn btn-primary btn-block" id="file-upload" type="file" name="estimates" accept=".csv">
			</div>
	  	</div>
	</form>

  <select class="selectpicker" id="year" data-style="btn-primary" data-width="auto">
    <option value="2017">2017</option>
    <option value="2016">2016</option>
    <option value="2015">2015</option>
  </select>

</div>

<div class="container-fluid">
  <div class="table-responsive" id='estimateTable'>
  </div>
</div>
{% endblock %}
{% block content2 %}
<!-- reference to js file
<script type="text/javascript" src='../static/js/estimates.js'></script> -->
<script>
  var estimateTable = document.getElementById('estimateTable');

  function uploadValues(e) {
    var message = 'Upload Prices File'
    console.log(message)
    var formdata = new FormData(document.getElementById("upload-form"));
    $.ajax({
        type: 'POST',
        url: '/uploadEstimates/',
        data : formdata,
        processData: false,
        contentType: false,
        success: function(response){
          console.log('good')
          refreshTable();
        }
    });
  }

  function getValues(categoryURL, category) {
    $.ajax({
        type: 'GET',
        url: categoryURL,
        success: function(result) {
            updateEstimateTable(result, category);
        },
        error: function(result) {
            showError(category);
        }
    });
  }

  function updateEstimateTable(result, category) {
    estimateTable.appendChild(makeHeader(category));
    table = makeTable();
    result.forEach(function(row) {
      table.appendChild(makeRow(row));
    });
    estimateTable.appendChild(table);
  }

  function makeTable() {
    // Returns a new table with table headers
     var table = document.createElement('table');
     table.setAttribute('class', 'table');
     var headerRow = document.createElement('tr');

     var col1 = document.createElement('th');
     col1.setAttribute('width', '50%');
     col1.innerHTML = 'Name';
     headerRow.appendChild(col1);

     var col2 = document.createElement('th');
     col2.setAttribute('width', '50%');
     col2.innerHTML = 'Value';
     headerRow.appendChild(col2);

     table.appendChild(headerRow);
     return table;
  }

  function makeHeader(string) {
    // Returns a new header
    var header = document.createElement('h4');
    header.setAttribute('class', 'text-green accordion');
    header.setAttribute('style', 'font-weight: bold; padding-top: 10px;');
    header.innerHTML = string;

    // Add accordion functionality to header classes
    // Source: https://www.w3schools.com/howto/howto_js_accordion.asp
    header.onclick = function(){
        /* Toggle between adding and removing the "active" class,
        to highlight the button that controls the panel */
        this.classList.toggle("active");

        /* Toggle between hiding and showing the active panel */
        var panel = this.nextElementSibling;
        if (panel.style.display === "block") {
            panel.style.display = "none";
        } else {
            panel.style.display = "block";
        }
    }
    return header;
  }

  function makeRow(rowData) {
    // Returns a table row with data from the json object given
    var row = document.createElement('tr');

    var col1 = document.createElement('td');
    col1.setAttribute('width', '35%');
    col1.innerHTML = rowData.name;
    row.appendChild(col1);

    var col2 = document.createElement('td');
    col2.setAttribute('width', '15%');
    col2.innerHTML = rowData.value;
    row.appendChild(col2);

    return row;
  }

  function refreshTable() {
    $('#estimateTable').empty();
    getValues('/getStyleEstimates/', 'Style');
    getValues('/getColourEstimates/', 'Colour');
    getValues('/getHeightEstimates/', 'Height');
    getValues('/getGateEstimates/', 'Gate');
  }

  function showError(category) {
    // Show an error if there are no estimate values
    estimateTable.appendChild(makeHeader(category));
    var item = document.createElement('a');
    item.appendChild(document.createTextNode('No estimate values were found for ' + category));
    estimateTable.appendChild(item);
  }

  $(document).ready(function(){
    refreshTable()
  });

  $('#file-upload').change(function(){
    $('#upload-form').submit();
  });

  $('form').submit(function(e) {
    e.preventDefault();
    uploadValues(e);
  });
</script>
{% endblock %}
