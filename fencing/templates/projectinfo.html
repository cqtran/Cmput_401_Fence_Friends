{% extends "base.html" %}
{% block content %}

<script src="../static/js/projectinfo.js"></script>

<!--
From:
https://coderwall.com/p/ijrrpa/flask-flash-messages-as-bootstrap-alert
-->
{% with messages = get_flashed_messages(with_categories=true) %}
<!-- Categories: success (green), info (blue), warning (yellow), danger (red) -->
{% if messages %}
  {% for category, message in messages %}
	<div class="alert alert-{{ category }} alert-dismissible" role="alert">
	<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	<!-- <strong>Title</strong> --> {{ message }}
	</div>
  {% endfor %}
{% endif %}
{% endwith %}

<div id="progress" class="modal fade">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="progressTitle" class="modal-title">Processing</h5>
      </div>
      <div class="modal-body">
        <div class="progress">
		  <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!--top name and status -->
<div class="container-fluid">
  <div class="row justify-content-between">
    <h1 id="project-name"></h1>
    <h4 class="float-right" id="status" style="padding-top: 10px; font-weight: bold;"></h4>
  </div>
</div>
<hr class="mt-2">

<div class="container make-centre" id="overlay" style="padding-bottom: 40px;">
  <td><img id="image" style="max-width:100%;cursor:pointer;" onclick="editDiagram(this);" <img id="drawiopic"  style="cursor:pointer;max-width:100%;" onclick="(function(img){if(img.wnd!=null&&!img.wnd.closed){img.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&&evt.source==img.wnd){img.wnd.postMessage(decodeURIComponent(img.getAttribute('src')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);img.wnd=window.open('https://csahmad.github.io/drawio/war/?client=1&lightbox=1&edit=_blank');}})(this);"/></td>
    <script>
	// From:
	// https://stackoverflow.com/questions/133925/javascript-post-request-like-a-form-submit/133997#133997
	// Acccessed November 8, 2017
	function post(url, params) {
	    var form = document.createElement("form");
	    form.setAttribute("method", "post");
	    form.setAttribute("action", url);

	    for(var key in params) {
	        if(params.hasOwnProperty(key)) {
	            var hiddenField = document.createElement("input");
	            hiddenField.setAttribute("type", "hidden");
	            hiddenField.setAttribute("name", key);
	            hiddenField.setAttribute("value", params[key]);

	            form.appendChild(hiddenField);
	        }
	    }

	    document.body.appendChild(form);
	    form.submit();
	}

	function saveDrawPicture() {
	    var initial = image.getAttribute('src');
		  post("{{ url_for('saveDiagram', proj_id=request.args.get('proj_id') ) }}", {image: initial});

	}

	function loadimage(image){
	    document.getElementById("image").src=image[0].project_info;
	}

	loadimage({{ drawiopic | safe }});

	</script>
</div>
<hr class="mt-2">
<div class="container-fluid">
	<div class="row justify-content-between">
		<div class="col-lg-6 col-md-6">
			<h4 class="text-green" style="font-weight: bold;">Address</h4>
			<p class="no-top-padding" id="address" style="font-weight: bold;" id="address"></p>
		</div>
		<!-- or class="float-right" -->
		<div class="col-lg-6 col-md-6">
			<h4 class="text-green" style="font-weight: bold;">Start Date</h4>
			<p class="no-top-padding" id="start-date" style="font-weight: bold;"></p>
			<h4 class="text-green" style="font-weight: bold;">End Date</h4>
			<p class="no-top-padding" id="end_date" style="font-weight: bold;">Ongoing</p>
		</div>
	</div>
</div>
<hr class="mt-2" id="noteContainer" style="display:none;">
<p id="savednote"></p>
<hr class="mt-2">

<!--<div class="col-lg-12">
  <div class="row" id="projectPictures"></div>
</div>-->
<div>
  <div class="HorizontalScrollList">
    <ul class="list-inline" id="projectPictures">
    </ul>
  </div>
</div>

<div class="modal fade" id="imagemodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" data-dismiss="modal">
    <div class="modal-content">
      <div class="modal-body">
        <img class="imagemodal" src="" id="imagepreview" >
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">
	<form method = "post" id="upload-form" action='javascript:uploadPicture();' enctype=multipart/form-data >
		<input class="form-control" type="hidden" name="proj_id" id="project_id" />
		<div class="row">
			<label for="file-upload" class="btn btn-primary btn-block">
			    Upload Image
			</label>
	  		<input class="btn btn-primary btn-block" id="file-upload" type="file" name="picture" accept="image/*">
		  	<!--<div class="col-sm-6 less-padding" style="padding-bottom: 8px;">
		  		<input class="btn btn-primary btn-block" type="submit" value="Upload picture">
		  	</div>-->
	  	</div>
	</form>
	<div class="row">
		<div class="col-sm-6 less-padding" style="padding-bottom: 8px;">
			<form method="post" target="_blank" action="{{url_for('viewQuote', proj_id=request.args.get('proj_id'))}}">
				<input class="btn btn-primary btn-block" type="submit" value="View Quote"/>
			</form>
		</div>
		<div class="col-sm-6 less-padding" style="padding-bottom: 8px;">
			<form method="post" target="_blank" action="{{url_for('viewMaterialList', proj_id=request.args.get('proj_id'))}}">
				<input class="btn btn-primary btn-block" type="submit" value="View Material List"/>
			</form>
		</div>
	</div>
	<div class="row">
		<div class="col-sm-6 less-padding" style="padding-bottom: 8px;">
			<form onSubmit="showSendingQuote();" method="post" action="{{url_for('sendQuote', proj_id=request.args.get('proj_id'))}}" data-toggle="modal" data-target="#progress">
				<input id="sendQuoteButton" class="btn btn-primary btn-block" type="submit" value="Send Quote"/>
			</form>
		</div>
		<div class="col-sm-6 less-padding" style="padding-bottom: 8px;">
			<form onSubmit="showSendingMaterialList();" method="post" action="{{url_for('sendMaterialList', proj_id=request.args.get('proj_id'))}}" data-toggle="modal" data-target="#progress">
				<input id="sendMaterialListButton" class="btn btn-primary btn-block" type="submit" value="Send Material List"/>
			</form>
		</div>
	</div>
</div>


<script type="text/javascript">

var imgPath = {{ imgPath|safe }}
var tbnPath = {{ tbnPath|safe }}
var pictureList = document.getElementById('projectPictures');
var url = new URL(window.location.href);
var proj_id = url.searchParams.get("proj_id");
document.getElementById("pencil-button").setAttribute('class', 'nav-item');

var requestProj = new XMLHttpRequest();
requestProj.onreadystatechange = function(response) {
  if (requestProj.readyState === 4) {
    if (requestProj.status === 200) {
		// Parse the JSON
		var project = JSON.parse(requestProj.responseText);
		document.getElementById('project-name').innerHTML = project[0].project_name;
		document.getElementById('status').innerHTML = "â–  " + project[0].status_name;
		document.getElementById('address').innerHTML = project[0].address;
		document.getElementById('start-date').innerHTML = project[0].start_date;
		if(project[0].status_name == "Paid"){
		  document.getElementById("status").setAttribute('class', 'float-right paid-text');
		}
		else if(project[0].status_name == "Not Reached"){
		  document.getElementById("status").setAttribute('class', 'float-right not-reached-text');
		}
		else if(project[0].status_name == "Appraisal Booked"){
		  document.getElementById("status").setAttribute('class', 'float-right appraisal-booked-text');
		}
		else if(project[0].status_name == "Waiting for Appraisal"){
		  document.getElementById("status").setAttribute('class', 'float-right waiting-appraisal-text');
		}
		else if(project[0].status_name == "Appraised"){
		  document.getElementById("status").setAttribute('class', 'float-right appraised-text');
		}
		else if(project[0].status_name == "Quote Sent"){
		  document.getElementById("status").setAttribute('class', 'float-right quote-sent-text');
		}
		else if(project[0].status_name == "Waiting for Alberta1Call"){
		  document.getElementById("status").setAttribute('class', 'float-right waiting-alberta-text');
		}
		else if(project[0].status_name == "Installation Pending"){
		  document.getElementById("status").setAttribute('class', 'float-right install-pending-text');
		}
		else if(project[0].status_name == "Installing"){
		  document.getElementById("status").setAttribute('class', 'float-right installing-text');
		}
		else if(project[0].status_name == "No Longer Interested"){
		  document.getElementById("status").setAttribute('class', 'float-right not-interested-text');
		}

		// Sets the project_id into the uploadpicture form
		document.getElementById('project_id').setAttribute('value', project[0].project_id);

		document.getElementById('editproject').setAttribute('onclick', 'projectClicked('+project[0].project_id+')')

		if (project[0].end_date != null) {
			document.getElementById('end_date').innerHTML = project[0].end_date;
		}
		var note = project[0].note;
		if (!(note == null || note.trim() == "")) {
			document.getElementById('savednote').innerHTML = project[0].note;
			document.getElementById('noteContainer').style.display = "block";
		}
    }
  }
}

requestProj.open('GET', '/getProject/' + proj_id, true);
requestProj.send()

var request = new XMLHttpRequest();
request.onreadystatechange = function(response) {

  if (request.readyState === 4) {
    if (request.status === 200) {
      // Parse the JSON
      var jsonOptions = JSON.parse(request.responseText);

      jsonOptions.forEach(function(picture) {
        var img = document.createElement('img');
        var final = document.createElement('a');

		img.src =  tbnPath + picture.thumbnail_name;
		img.alt =  picture.thumbnail_name + ' not found';
        final.setAttribute('href', '#');
        final.setAttribute('class', 'PictureThumbnail card')
        console.log(picture.file_name)
        // this is where you want to go when you click
        final.addEventListener('click', function(){
          jQuery.noConflict();
          $('#imagepreview').attr('src', imgPath + picture.file_name);
          $('#imagemodal').modal('show');
        });
        //link.setAttribute('onclick', 'customerClicked('+customer.customer_id+')')
        final.appendChild(img);

		//img.className += 'img-thumbnail'
		// Add it to the list:
		pictureList.appendChild(final);

      })
    }
    if (request.status === 400) {
      // No images for this project
      var img = document.createElement('img');
      img.src =  tbnPath + 'No_picture_available.png';
      img.alt =  'No pictures available';
      img.height = '150';
      img.width = '150';
      pictureList.appendChild(img);
    }
  }
}
request.open('GET', '/getPictureList/' + proj_id, true);
request.send()

  function uploadPicture() {
    var uploadRequest = new XMLHttpRequest();
    var formData = new FormData( document.getElementById("upload-form") );
    uploadRequest.open('POST', '/uploadPicture/', true);
    uploadRequest.onreadystatechange = function(response) {
          window.location.reload();
    }
    uploadRequest.send(formData);
  }

	function projectClicked(id) {
		window.location.href= '/editprojectinfo?proj_id='+id
	}

			function editDiagram(image)
			{
				var initial = image.getAttribute('src');
				image.setAttribute('src', 'https://csahmad.github.io/drawio/war/images/ajax-loader.gif');
				var iframe = document.createElement('iframe');
				iframe.setAttribute('style', "position:fixed; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;")
				//iframe.setAttribute('frameborder', '0');
				//iframe.setAttribute('width', '80%');
				//iframe.setAttribute('height', '1000');
				//iframe.setAttribute('align', 'right');

				var close = function()
				{
					image.setAttribute('src', initial);
					document.body.removeChild(iframe);
					window.removeEventListener('message', receive);
				};
				var receive = function(evt)
				{
					if (evt.data.length > 0)
					{
						var msg = JSON.parse(evt.data);

						if (msg.event == 'init')
						{
							iframe.contentWindow.postMessage(JSON.stringify({action: 'load',
								xml: initial}), '*');
						}
						else if (msg.event == 'export')
						{
							close();
							image.setAttribute('src', msg.data);
							save(location.href);
							saveDrawPicture();
						}
						else if (msg.event == 'save')
						{
							iframe.contentWindow.postMessage(JSON.stringify({action: 'export',
								format: 'xmlsvg', spin: 'Updating page'}), '*');
						}
						else if (msg.event == 'exit')
						{
							close();
						}
					}
				};
				window.addEventListener('message', receive);
				iframe.setAttribute('src', 'https://csahmad.github.io/drawio/war/?embed=1&ui=atlas&spin=1&modified=unsavedChanges&proto=json');
				document.body.appendChild(iframe);
			};

			function save(url)
			{
				if (url != null)
				{
					var req = new XMLHttpRequest();
					req.withCredentials = true;
					var wnd = (url != window.location.href) ? window.open() : null;

					req.onreadystatechange = function()
					{
						if (req.readyState == 4)
						{
							if (req.status != 200 && req.status != 201)
							{
								if (wnd != null)
								{
									wnd.close();
								}

								alert('Error ' + req.status);
							}
							else if (wnd != null)
							{
								wnd.location.href = url;
							}
						}
					};

					req.open('PUT', url, true);
					req.send(document.documentElement.outerHTML);
				}
			}
</script>
<script type="text/javascript">
	document.getElementById("file-upload").onchange = function() {
    document.getElementById("upload-form").submit();
}
</script>
{% endblock %}
