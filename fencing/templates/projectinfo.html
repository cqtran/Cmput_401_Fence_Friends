{% extends "base.html" %}
{% block content %}

<script src="../static/js/projectinfo.js"></script>

<!--
From:
https://coderwall.com/p/ijrrpa/flask-flash-messages-as-bootstrap-alert
-->
{% with messages = get_flashed_messages(with_categories=true) %}
<!-- Categories: success (green), info (blue), warning (yellow), danger (red) -->
{% if messages %}
  {% for category, message in messages %}
	<div class="alert alert-{{ category }} alert-dismissible" role="alert">
	<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	<!-- <strong>Title</strong> --> {{ message }}
	</div>
  {% endfor %}
{% endif %}
{% endwith %}

<div id="progress" class="modal fade">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="progressTitle" class="modal-title">Processing</h5>
      </div>
      <div class="modal-body">
        <div class="progress">
		  <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<h1>
	<p id="project_name"></p>
</h1>

<div class="container" id="overlay" >

  <td><img id="image" style="max-width:100%;cursor:pointer;" onclick="editDiagram(this);" <img id="drawiopic"  style="cursor:pointer;max-width:100%;" onclick="(function(img){if(img.wnd!=null&&!img.wnd.closed){img.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&&evt.source==img.wnd){img.wnd.postMessage(decodeURIComponent(img.getAttribute('src')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);img.wnd=window.open('https://csahmad.github.io/drawio/war/?client=1&lightbox=1&edit=_blank');}})(this);"/></td>
    <script>
// From:
// https://stackoverflow.com/questions/133925/javascript-post-request-like-a-form-submit/133997#133997
// Acccessed November 8, 2017
function post(url, params) {
    var form = document.createElement("form");
    form.setAttribute("method", "post");
    form.setAttribute("action", url);

    for(var key in params) {
        if(params.hasOwnProperty(key)) {
            var hiddenField = document.createElement("input");
            hiddenField.setAttribute("type", "hidden");
            hiddenField.setAttribute("name", key);
            hiddenField.setAttribute("value", params[key]);

            form.appendChild(hiddenField);
        }
    }

    document.body.appendChild(form);
    form.submit();
}

function saveDrawPicture() {
    var initial = image.getAttribute('src');
    console.log("asdkl;fjadks;")
	console.log(initial);
	post("{{ url_for('saveDiagram', proj_id=request.args.get('proj_id') ) }}", {image: initial});

}

function loadimage(image){
    document.getElementById("image").src=image[0].project_info;
}

loadimage({{ drawiopic | safe }});

</script>

	<p id="address"></p>
	<p id="status"></p>
	<p id="start_date"></p>
	<p id="end_date">End Date: Ongoing</p>
  <p id="savednote">Note</p>
	<button type="button" id="editproject">Click to edit project information</button>
	<br> <br>
	<div class="row" id = 'projectPictures'></div>
</div>

<form method = "post" action="{{ url_for('uploadpicture') }}" enctype=multipart/form-data >
	<input class="form-control" type="hidden" name="proj_id" id="project_id" />
  <input type="file" name="picture" accept="image/*">
  <input type="submit" value="Upload picture">
</form>

<br>
<form method="post" target="_blank" action="{{url_for('viewQuote', proj_id=request.args.get('proj_id'))}}">
	<input class="btn btn-primary btn-block" type="submit" value="View Quote"/>
</form>

<br>
<form method="post" target="_blank" action="{{url_for('viewMaterialList', proj_id=request.args.get('proj_id'))}}">
	<input class="btn btn-primary btn-block" type="submit" value="View Material List"/>
</form>

<br>
<br>
<form onSubmit="showSendingQuote();" method="post" action="{{url_for('sendQuote', proj_id=request.args.get('proj_id'))}}" data-toggle="modal" data-target="#progress">
	<input id="sendQuoteButton" class="btn btn-primary btn-block" type="submit" value="Send Quote ►"/>
</form>

<br>
<form onSubmit="showSendingMaterialList();" method="post" action="{{url_for('sendMaterialList', proj_id=request.args.get('proj_id'))}}" data-toggle="modal" data-target="#progress">
	<input id="sendMaterialListButton" class="btn btn-primary btn-block" type="submit" value="Send Material List ►"/>
</form>

<script type="text/javascript">

var imgPath = {{ path|safe }}
var pictureList = document.getElementById('projectPictures');
var url = new URL(window.location.href);
var proj_id = url.searchParams.get("proj_id");

var requestProj = new XMLHttpRequest();
requestProj.onreadystatechange = function(response) {
  if (requestProj.readyState === 4) {
    if (requestProj.status === 200) {
      // Parse the JSON
      var project = JSON.parse(requestProj.responseText);
      document.getElementById('project_name').innerHTML = project[0].project_name;
  		document.getElementById('status').innerHTML = 'Status: ' + project[0].status_name;
  		document.getElementById('address').innerHTML = 'Address: ' + project[0].address;
  		document.getElementById('start_date').innerHTML = 'Start Date: ' + project[0].start_date;

  		// Sets the project_id into the uploadpicture form
  		document.getElementById('project_id').setAttribute('value', project[0].project_id);

  		document.getElementById('editproject').setAttribute('onclick', 'projectClicked('+project[0].project_id+')')

  		if (project[0].end_date != null) {
  			document.getElementById('end_date').innerHTML = 'End Date: ' + project[0].end_date;
  		}

  		document.getElementById('savednote').innerHTML = 'Notes: ' + project[0].note;
    }
  }
}

requestProj.open('GET', '/getProject/' + proj_id, true);
requestProj.send()

var request = new XMLHttpRequest();
request.onreadystatechange = function(response) {

  if (request.readyState === 4) {
    if (request.status === 200) {
      // Parse the JSON
      var jsonOptions = JSON.parse(request.responseText);
      if (jsonOptions.length == 0) {
        var img = document.createElement('img');
        img.src =  imgPath + 'No_picture_available.png';
        img.alt =  'No pictures available';
        img.height = '150';
        img.width = '150';
        pictureList.appendChild(img);
      }
      jsonOptions.forEach(function(picture) {
        var img = document.createElement('img');
				img.src =  imgPath + picture.file_name;
				img.alt =  picture.file_name + ' not found';
        console.log(imgPath + picture.file_name)
				img.height = '384';
				img.width = '512';
				img.className += 'img-thumbnail'
				// Add it to the list:
				pictureList.appendChild(img);
      })
    }
  }
}
request.open('GET', '/getPictureList/' + proj_id, true);
request.send()

	//displayProjectInfo({{ proj|safe }});
	//displayPictures({{ images|safe }}, {{ path|safe }});

	function projectClicked(id) {
		window.location.href= '/editprojectinfo?proj_id='+id
	}

			function editDiagram(image)
			{
				var initial = image.getAttribute('src');
				image.setAttribute('src', 'https://csahmad.github.io/drawio/war/images/ajax-loader.gif');
				var iframe = document.createElement('iframe');
				iframe.setAttribute('style', "position:fixed; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;")
				//iframe.setAttribute('frameborder', '0');
				//iframe.setAttribute('width', '80%');
				//iframe.setAttribute('height', '1000');
				//iframe.setAttribute('align', 'right');

				var close = function()
				{
					image.setAttribute('src', initial);
					document.body.removeChild(iframe);
					window.removeEventListener('message', receive);
				};
				var receive = function(evt)
				{
					if (evt.data.length > 0)
					{
						var msg = JSON.parse(evt.data);

						if (msg.event == 'init')
						{
							iframe.contentWindow.postMessage(JSON.stringify({action: 'load',
								xml: initial}), '*');
						}
						else if (msg.event == 'export')
						{
							close();
							image.setAttribute('src', msg.data);
							save(location.href);
							saveDrawPicture();
						}
						else if (msg.event == 'save')
						{
							iframe.contentWindow.postMessage(JSON.stringify({action: 'export',
								format: 'xmlsvg', spin: 'Updating page'}), '*');
						}
						else if (msg.event == 'exit')
						{
							close();
						}
					}
				};
				window.addEventListener('message', receive);
				iframe.setAttribute('src', 'https://csahmad.github.io/drawio/war/?embed=1&ui=atlas&spin=1&modified=unsavedChanges&proto=json');
				document.body.appendChild(iframe);
			};

			function save(url)
			{
				if (url != null)
				{
					var req = new XMLHttpRequest();
					req.withCredentials = true;
					var wnd = (url != window.location.href) ? window.open() : null;

					req.onreadystatechange = function()
					{
						if (req.readyState == 4)
						{
							if (req.status != 200 && req.status != 201)
							{
								if (wnd != null)
								{
									wnd.close();
								}

								alert('Error ' + req.status);
							}
							else if (wnd != null)
							{
								wnd.location.href = url;
							}
						}
					};

					req.open('PUT', url, true);
					req.send(document.documentElement.outerHTML);
				}
			}

		</script>
{% endblock %}
